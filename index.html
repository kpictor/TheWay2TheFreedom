<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>52æœŸæŠ•èµ„å­¦ä¹ ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #22c55e;
            --warning: #f59e0b;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Navigation */
        .nav-section {
            padding: 16px;
        }

        .nav-section h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--bg-hover);
        }

        .nav-item.active {
            background: var(--primary);
        }

        .nav-item .icon {
            width: 20px;
            margin-right: 12px;
        }

        .nav-item .label {
            font-size: 14px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--success);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Quarter sections */
        .quarter-nav {
            margin-top: 8px;
        }

        .quarter-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
        }

        .quarter-header:hover {
            background: var(--bg-hover);
        }

        .quarter-header .arrow {
            margin-left: auto;
            transition: transform 0.2s;
        }

        .quarter-header.expanded .arrow {
            transform: rotate(90deg);
        }

        .quarter-episodes {
            display: none;
            padding-left: 24px;
        }

        .quarter-episodes.show {
            display: block;
        }

        .episode-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
        }

        .episode-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .episode-item.completed::before {
            content: 'âœ“';
            color: var(--success);
            margin-right: 8px;
        }

        .episode-item.current {
            background: var(--primary);
            color: white;
        }

        /* Main content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 32px;
        }

        /* Header */
        .content-header {
            margin-bottom: 32px;
        }

        .breadcrumb {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .content-header h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .content-header p {
            color: var(--text-secondary);
        }

        /* Progress bar */
        .progress-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #a855f7);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Content area */
        .content-area {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 32px;
        }

        .content-area h3 {
            font-size: 20px;
            margin-bottom: 16px;
        }

        .content-area p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 16px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Markdown content */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .markdown-content code {
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }

        .markdown-content pre {
            background: var(--bg-dark);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            color: var(--text-secondary);
            margin: 16px 0;
        }

        /* Action buttons */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Settings panel */
        .settings-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 24px;
            transition: right 0.3s;
            z-index: 100;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .settings-header h3 {
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 99;
        }

        .overlay.show {
            display: block;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: var(--bg-card);
            padding: 48px;
            border-radius: 16px;
            width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .login-box .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .login-box .form-group {
            margin-bottom: 20px;
        }

        .login-box .error-msg {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .login-box .error-msg.show {
            display: block;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .user-info .avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .user-info .username {
            flex: 1;
            font-size: 14px;
        }

        .user-info .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .user-info .logout-btn:hover {
            color: var(--text-primary);
        }

        /* AI Chat Modal */
        .ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .ai-modal.show {
            display: flex;
        }

        .ai-modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 800px;
            height: 80vh;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .ai-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .ai-modal-footer input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .chat-message.user {
            background: var(--primary);
            margin-left: 20%;
        }

        .chat-message.ai {
            background: var(--bg-hover);
            margin-right: 20%;
        }

        .chat-intro {
            background: var(--bg-dark);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .chat-intro h4 {
            margin-bottom: 12px;
            color: var(--primary);
        }

        /* Pre-formatted text for diagrams */
        .markdown-content pre {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2>ğŸ“ˆ 52æœŸæŠ•èµ„å­¦ä¹ </h2>
            <p class="subtitle">æ´å¯Ÿå¸‚åœºåšå¼ˆä¹‹é“</p>

            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
            </div>

            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç ">
            </div>

            <div class="error-msg" id="loginError">ç™»å½•å¤±è´¥</div>

            <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 8px;">
                ç™»å½• / æ³¨å†Œ
            </button>

            <p style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                æ–°ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œ
            </p>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h1>ğŸ“ˆ 52æœŸæŠ•èµ„å­¦ä¹ </h1>
                <p>æ´å¯Ÿå¸‚åœºåšå¼ˆä¹‹é“</p>
            </div>

            <!-- User Info -->
            <div class="user-info" id="userInfo" style="margin: 16px;">
                <div class="avatar">ğŸ‘¤</div>
                <span class="username" id="displayUsername">æœªç™»å½•</span>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
            </div>

            <div class="nav-section">
                <h3>å­¦ä¹ è¿›åº¦</h3>
                <div class="nav-item active" onclick="showDashboard()">
                    <span class="icon">ğŸ </span>
                    <span class="label">ä»ªè¡¨ç›˜</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>è¯¾ç¨‹å†…å®¹</h3>
                <div class="quarter-nav" id="q1Nav">
                    <div class="quarter-header" onclick="toggleQuarter('q1')">
                        <span class="icon">ğŸ“š</span>
                        <span class="label">Q1 è®¤è¯†è‡ªæˆ‘ä¸å¸‚åœº</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="quarter-episodes" id="q1Episodes"></div>
                </div>
                <div class="quarter-nav" id="q2Nav">
                    <div class="quarter-header" onclick="toggleQuarter('q2')">
                        <span class="icon">ğŸ§ </span>
                        <span class="label">Q2 ç†è§£åšå¼ˆä¸è¡Œä¸º</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="quarter-episodes" id="q2Episodes"></div>
                </div>
                <div class="quarter-nav" id="q3Nav">
                    <div class="quarter-header" onclick="toggleQuarter('q3')">
                        <span class="icon">âš™ï¸</span>
                        <span class="label">Q3 å»ºç«‹ç³»ç»Ÿä¸ç­–ç•¥</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="quarter-episodes" id="q3Episodes"></div>
                </div>
                <div class="quarter-nav" id="q4Nav">
                    <div class="quarter-header" onclick="toggleQuarter('q4')">
                        <span class="icon">ğŸš€</span>
                        <span class="label">Q4 å®æˆ˜ä¸è¿›åŒ–</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="quarter-episodes" id="q4Episodes"></div>
                </div>
            </div>

            <div class="nav-section">
                <h3>å·¥å…·</h3>
                <div class="nav-item" onclick="openSettings()">
                    <span class="icon">âš™ï¸</span>
                    <span class="label">è®¾ç½®</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard view -->
            <div id="dashboardView">
                <div class="content-header">
                    <div class="breadcrumb">é¦–é¡µ</div>
                    <h2>æ¬¢è¿å›æ¥ ğŸ‘‹</h2>
                    <p>ç»§ç»­ä½ çš„æŠ•èµ„å­¦ä¹ ä¹‹æ—…</p>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>æ€»ä½“è¿›åº¦</span>
                        <span id="progressText">0/52 æœŸå®Œæˆ</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="content-area">
                    <h3>ğŸ“Œ ç»§ç»­å­¦ä¹ </h3>
                    <p>ç‚¹å‡»å·¦ä¾§å­£åº¦å±•å¼€è¯¾ç¨‹åˆ—è¡¨ï¼Œé€‰æ‹©æœŸæ•°å¼€å§‹å­¦ä¹ ã€‚</p>
                    <p>æ¯æœŸåŒ…å«ï¼šä¸»å†…å®¹ + AIæ·±åº¦å­¦ä¹ åŒ… + è´¹æ›¼ä½œä¸š</p>

                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="startNextEpisode()">
                            å¼€å§‹ä¸‹ä¸€æœŸ â†’
                        </button>
                        <button class="btn btn-secondary" onclick="openSettings()">
                            é…ç½®AI
                        </button>
                    </div>
                </div>
            </div>

            <!-- Episode view -->
            <div id="episodeView" style="display: none;">
                <div class="content-header">
                    <div class="breadcrumb" id="episodeBreadcrumb">Q1 / EP01</div>
                    <h2 id="episodeTitle">æŠ•èµ„çš„ç¬¬ä¸€æ€§åŸç†</h2>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('content')">ğŸ“˜ ä¸»å†…å®¹</div>
                    <div class="tab" onclick="switchTab('ai')">ğŸ¤– AIå­¦ä¹ </div>
                    <div class="tab" onclick="switchTab('homework')">âœï¸ è´¹æ›¼ä½œä¸š</div>
                </div>

                <div class="content-area">
                    <div id="tabContent" class="markdown-content">
                        <!-- Content will be loaded here -->
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-secondary" onclick="prevEpisode()">â† ä¸Šä¸€æœŸ</button>
                        <button class="btn btn-success" id="completeBtn" onclick="toggleComplete()">âœ“ æ ‡è®°å®Œæˆ</button>
                        <button class="btn btn-primary" onclick="nextEpisode()">ä¸‹ä¸€æœŸ â†’</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Panel -->
    <div class="overlay" id="overlay" onclick="closeSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3>âš™ï¸ è®¾ç½®</h3>
            <button class="close-btn" onclick="closeSettings()">Ã—</button>
        </div>

        <div class="form-group">
            <label>AI Provider</label>
            <select id="aiProvider">
                <option value="openai">OpenAI</option>
                <option value="gemini">Google Gemini</option>
                <option value="claude">Anthropic Claude</option>
            </select>
        </div>

        <div class="form-group">
            <label>API Key</label>
            <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„API Key">
        </div>

        <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%;">
            ä¿å­˜è®¾ç½®
        </button>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h4 style="margin-bottom: 12px;">æ•°æ®ç®¡ç†</h4>
            <button class="btn btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 8px;">
                å¯¼å‡ºå­¦ä¹ æ•°æ®
            </button>
            <button class="btn btn-secondary" onclick="resetProgress()" style="width: 100%;">
                é‡ç½®è¿›åº¦
            </button>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div class="ai-modal" id="aiModal">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3 id="aiModalTitle">ğŸ¤– AIäº¤äº’ç»ƒä¹ </h3>
                <button class="close-btn" onclick="closeAIModal()">Ã—</button>
            </div>
            <div class="ai-modal-body" id="aiChatBody">
                <!-- Chat content will be loaded here -->
            </div>
            <div class="ai-modal-footer">
                <input type="text" id="aiInput" placeholder="è¾“å…¥ä½ çš„å›ç­”..."
                    onkeypress="if(event.key==='Enter')sendAIMessage()">
                <button class="btn btn-primary" onclick="sendAIMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // Episode data
        const episodes = {
            q1: [
                { id: 1, title: 'æŠ•èµ„çš„ç¬¬ä¸€æ€§åŸç†' },
                { id: 2, title: 'ä¸ºä»€ä¹ˆå¤§å¤šæ•°äººäºé’±' },
                { id: 3, title: 'å¸‚åœºæ˜¯ä¸€å°ä»€ä¹ˆæœºå™¨' },
                { id: 4, title: 'è°åœ¨å’Œä½ åšå¼ˆ' },
                { id: 5, title: 'ä¿¡æ¯ä¸å¯¹ç§°çš„çœŸç›¸' },
                { id: 6, title: 'åŸºé‡‘ç»ç†çš„æ¿€åŠ±é”™ä½' },
                { id: 7, title: 'è®¤çŸ¥è‡ªå·±çš„è´¢åŠ¡çŠ¶å†µ' },
                { id: 8, title: 'é£é™©å®¹å¿åº¦è‡ªæµ‹' },
                { id: 9, title: 'æŠ•èµ„ç›®æ ‡çš„è®¾å®š' },
                { id: 10, title: 'æ—¶é—´çš„å¤åˆ©æ•ˆåº”' },
                { id: 11, title: 'æˆæœ¬çš„éšå½¢æ€æ‰‹' },
                { id: 12, title: 'æƒ…ç»ªæ—¥è®°åˆä½“éªŒ' },
                { id: 13, title: 'Q1å­£åº¦å¤ç›˜' }
            ],
            q2: [
                { id: 14, title: 'å¸‚åœºæ˜¯äººå¿ƒçš„æ˜ å°„' },
                { id: 15, title: 'è´ªå©ªä¸ææƒ§çš„ç¥ç»ç§‘å­¦' },
                { id: 16, title: '12ä¸ªè‡´å‘½è®¤çŸ¥åå·®' },
                { id: 17, title: 'ç¾Šç¾¤æ•ˆåº”çš„åŠ›é‡' },
                { id: 18, title: 'å™äº‹ç»æµå­¦' },
                { id: 19, title: 'ç¾è”å‚¨çš„å¿ƒç†æ¸¸æˆ' },
                { id: 20, title: 'åº„å®¶æ€ç»´å…¥é—¨' },
                { id: 21, title: 'åšå¼ˆè®ºåŸºç¡€' },
                { id: 22, title: 'åèº«æ€§ç†è®º' },
                { id: 23, title: 'å¸‚åœºå‘¨æœŸçš„å¿ƒç†é˜¶æ®µ' },
                { id: 24, title: 'ä¿¡æ¯èŒ§æˆ¿ä¸é€†å‘æ€ç»´' },
                { id: 25, title: 'ç¾¤ä½“æ™ºæ…§vsç¾¤ä½“ç–¯ç‹‚' },
                { id: 26, title: 'Q2å­£åº¦å¤ç›˜' }
            ],
            q3: [
                { id: 27, title: 'ä»€ä¹ˆæ˜¯æŠ•èµ„ç³»ç»Ÿ' },
                { id: 28, title: 'èµ„äº§é…ç½®çš„æ•°å­¦åŸç†' },
                { id: 29, title: 'ä»“ä½ç®¡ç†çš„ç”Ÿå­˜æ³•åˆ™' },
                { id: 30, title: 'å…¥åœºè§„åˆ™è®¾è®¡' },
                { id: 31, title: 'å‡ºåœºè§„åˆ™è®¾è®¡' },
                { id: 32, title: 'é£é™©é¢„ç®—æ€ç»´' },
                { id: 33, title: 'å› å­æŠ•èµ„å…¥é—¨' },
                { id: 34, title: 'ETFä¸è¢«åŠ¨æŠ•èµ„' },
                { id: 35, title: 'AIåœ¨æŠ•èµ„ä¸­çš„åº”ç”¨' },
                { id: 36, title: 'ç”¨AIæ„å»ºä¿¡æ¯è¿‡æ»¤ç³»ç»Ÿ' },
                { id: 37, title: 'å›æµ‹æ€ç»´ä¸å±€é™' },
                { id: 38, title: 'ç³»ç»Ÿæ–‡æ¡£åŒ–' },
                { id: 39, title: 'Q3å­£åº¦å¤ç›˜' }
            ],
            q4: [
                { id: 40, title: 'å°é¢å®ç›˜å¯åŠ¨' },
                { id: 41, title: 'äº¤æ˜“æ—¥å¿—çš„åŠ›é‡' },
                { id: 42, title: 'å‘¨å¤ç›˜æ–¹æ³•è®º' },
                { id: 43, title: 'å¤„ç†è¿ç»­äºæŸ' },
                { id: 44, title: 'å¤„ç†è¿ç»­ç›ˆåˆ©' },
                { id: 45, title: 'å¸‚åœºå¼‚å¸¸äº‹ä»¶åº”å¯¹' },
                { id: 46, title: 'ä»é”™è¯¯ä¸­å­¦ä¹ çš„æ¡†æ¶' },
                { id: 47, title: 'å‡çº§ä½ çš„æŠ•èµ„ç³»ç»Ÿ' },
                { id: 48, title: 'å»ºç«‹è‡ªå·±çš„åŸåˆ™æ¸…å•' },
                { id: 49, title: 'ä¸AIåä½œçš„è¿›é˜¶' },
                { id: 50, title: 'ç¤¾åŒºä¸æˆé•¿' },
                { id: 51, title: 'å¹´åº¦å¤ç›˜' },
                { id: 52, title: 'åˆæ ¼æŠ•èµ„è€…çš„å®šä¹‰' }
            ]
        };

        // API Base URL (change for production)
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';

        // State
        let currentUser = null;
        let currentEpisode = 1;
        let completedEpisodes = [];
        let settings = {};

        // Initialize
        function init() {
            // Check if logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('displayUsername').textContent = currentUser;
                loadUserData();
            }
            renderEpisodeList();
            updateProgress();
            loadSettings();
        }

        // Login function
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showLoginError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (data.success) {
                    currentUser = data.username;
                    localStorage.setItem('currentUser', currentUser);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('displayUsername').textContent = currentUser;

                    // Load user data
                    if (data.data) {
                        completedEpisodes = data.data.completedEpisodes || [];
                        currentEpisode = data.data.currentEpisode || 1;
                    }

                    updateProgress();
                    renderEpisodeList();
                } else {
                    showLoginError(data.error || 'ç™»å½•å¤±è´¥');
                }
            } catch (err) {
                // Fallback to localStorage if server not available
                console.log('Server not available, using localStorage');
                currentUser = username;
                localStorage.setItem('currentUser', currentUser);
                completedEpisodes = JSON.parse(localStorage.getItem(`progress_${username}`) || '[]');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('displayUsername').textContent = currentUser;
                updateProgress();
                renderEpisodeList();
            }
        }

        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            completedEpisodes = [];
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        async function loadUserData() {
            if (!currentUser) return;

            try {
                const res = await fetch(`${API_BASE}/api/progress/${currentUser}`);
                const data = await res.json();

                if (data.success && data.progress) {
                    completedEpisodes = data.progress.completedEpisodes || [];
                    currentEpisode = data.progress.currentEpisode || 1;
                    updateProgress();
                    renderEpisodeList();
                }
            } catch (err) {
                // Fallback to localStorage
                completedEpisodes = JSON.parse(localStorage.getItem(`progress_${currentUser}`) || '[]');
                updateProgress();
                renderEpisodeList();
            }
        }

        async function saveUserProgress() {
            if (!currentUser) return;

            // Always save to localStorage as backup
            localStorage.setItem(`progress_${currentUser}`, JSON.stringify(completedEpisodes));

            try {
                await fetch(`${API_BASE}/api/progress/${currentUser}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        progress: {
                            completedEpisodes,
                            currentEpisode
                        }
                    })
                });
            } catch (err) {
                console.log('Server not available, saved to localStorage');
            }
        }

        function renderEpisodeList() {
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const container = document.getElementById(`${quarter}Episodes`);
                container.innerHTML = episodes[quarter].map(ep => `
                    <div class="episode-item ${completedEpisodes.includes(ep.id) ? 'completed' : ''} ${currentEpisode === ep.id ? 'current' : ''}" 
                         onclick="loadEpisode(${ep.id})">
                        EP${String(ep.id).padStart(2, '0')} ${ep.title}
                    </div>
                `).join('');
            });
        }

        function toggleQuarter(quarter) {
            const header = document.querySelector(`#${quarter}Nav .quarter-header`);
            const episodes = document.getElementById(`${quarter}Episodes`);
            header.classList.toggle('expanded');
            episodes.classList.toggle('show');
        }

        function loadEpisode(id) {
            currentEpisode = id;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('episodeView').style.display = 'block';

            const quarter = id <= 13 ? 'q1' : id <= 26 ? 'q2' : id <= 39 ? 'q3' : 'q4';
            const ep = episodes[quarter].find(e => e.id === id);

            document.getElementById('episodeBreadcrumb').textContent = `${quarter.toUpperCase()} / EP${String(id).padStart(2, '0')}`;
            document.getElementById('episodeTitle').textContent = ep.title;

            switchTab('content');
            renderEpisodeList();
            updateCompleteButton();
        }

        async function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');

            const content = document.getElementById('tabContent');
            const epNum = String(currentEpisode);

            if (tab === 'content') {
                content.innerHTML = '<p>åŠ è½½ä¸­...</p>';
                try {
                    const res = await fetch(`${API_BASE}/api/content/episode/${epNum}`);
                    const data = await res.json();
                    if (data.success) {
                        content.innerHTML = `<div class="markdown-content">${marked(data.content)}</div>`;
                    } else {
                        content.innerHTML = `<p>å†…å®¹æš‚æœªå¡«å……</p>`;
                    }
                } catch (err) {
                    content.innerHTML = `<p>åŠ è½½å¤±è´¥: ${err.message}</p>`;
                }
            } else if (tab === 'ai') {
                content.innerHTML = '<p>åŠ è½½ä¸­...</p>';
                try {
                    // First get list of deep learning files
                    const listRes = await fetch(`${API_BASE}/api/content/deep-learning/${epNum}`);
                    const listData = await listRes.json();

                    if (listData.success && listData.files.length > 0) {
                        let html = '<h3>ğŸ“š æ·±åº¦å­¦ä¹ èµ„æ–™</h3><div style="display: grid; gap: 12px;">';
                        for (const file of listData.files) {
                            html += `<div class="content-card" onclick="loadDeepContent('${file}')" style="padding: 16px; background: var(--bg-hover); border-radius: 8px; cursor: pointer;">
                                <strong>${file}</strong>
                            </div>`;
                        }
                        html += '</div><div id="deepContentArea" style="margin-top: 24px;"></div>';

                        // Also list AI prompts
                        const promptRes = await fetch(`${API_BASE}/api/content/ai-prompts/${epNum}`);
                        const promptData = await promptRes.json();
                        if (promptData.success && promptData.files.length > 0) {
                            html += '<h3 style="margin-top: 32px;">ğŸ¤– AIäº¤äº’ç»ƒä¹ </h3><div style="display: grid; gap: 12px;">';
                            for (const file of promptData.files) {
                                html += `<div class="content-card" onclick="loadPromptContent('${file}')" style="padding: 16px; background: var(--primary); border-radius: 8px; cursor: pointer; color: white;">
                                    <strong>${file}</strong>
                                </div>`;
                            }
                            html += '</div>';
                        }

                        content.innerHTML = html;
                    } else {
                        content.innerHTML = '<p>æ·±åº¦å­¦ä¹ å†…å®¹æš‚æœªå¡«å……</p>';
                    }
                } catch (err) {
                    content.innerHTML = `<p>åŠ è½½å¤±è´¥: ${err.message}</p>`;
                }
            } else {
                content.innerHTML = `
                    <h3>âœï¸ è´¹æ›¼ä½œä¸š</h3>
                    <p>ç”¨è‡ªå·±çš„è¯è§£é‡Šæœ¬æœŸæ ¸å¿ƒæ¦‚å¿µï¼š</p>
                    <textarea id="homeworkText" style="width: 100%; height: 200px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 16px; color: var(--text-primary); resize: vertical;" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„ç†è§£..."></textarea>
                    <button class="btn btn-primary" onclick="saveHomework()" style="margin-top: 12px;">ä¿å­˜ä½œä¸š</button>
                `;
            }
        }

        async function loadDeepContent(filename) {
            const area = document.getElementById('deepContentArea');
            area.innerHTML = '<p>åŠ è½½ä¸­...</p>';
            try {
                const res = await fetch(`${API_BASE}/api/content/deep-learning/${currentEpisode}/${encodeURIComponent(filename)}`);
                const data = await res.json();
                if (data.success) {
                    area.innerHTML = `<div class="markdown-content" style="background: var(--bg-dark); padding: 24px; border-radius: 8px;">${marked(data.content)}</div>`;
                }
            } catch (err) {
                area.innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
            }
        }

        // AI Chat State
        let currentPromptData = null;
        let chatMessages = [];
        let episodeContext = '';

        async function loadPromptContent(filename) {
            try {
                const res = await fetch(`${API_BASE}/api/content/ai-prompts/${currentEpisode}/${encodeURIComponent(filename)}`);
                const data = await res.json();
                const epRes = await fetch(`${API_BASE}/api/content/episode/${currentEpisode}`);
                const epData = await epRes.json();
                episodeContext = epData.success ? epData.content : '';
                if (data.success) {
                    currentPromptData = { title: filename, content: data.content };
                    openAIModal(filename, data.content);
                }
            } catch (err) { alert('åŠ è½½å¤±è´¥'); }
        }

        function openAIModal(title, promptContent) {
            document.getElementById('aiModalTitle').textContent = 'ğŸ¤– ' + title;
            chatMessages = [];
            const introMatch = promptContent.match(/## ä½¿ç”¨è¯´æ˜[\s\S]*?(?=---)/);
            const intro = introMatch ? introMatch[0].replace('## ä½¿ç”¨è¯´æ˜', '').trim() : 'ä¸AIè¿›è¡Œäº¤äº’å¼å­¦ä¹ ';
            document.getElementById('aiChatBody').innerHTML = '<div class="chat-intro"><h4>ğŸ“‹ ç»ƒä¹ è¯´æ˜</h4><p>' + intro + '</p></div><div id="chatMessages">' +
                (!settings.apiKey ? '<div style="text-align:center;padding:40px;color:var(--text-secondary);"><p>è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key</p><button class="btn btn-primary" onclick="closeAIModal();openSettings();" style="margin-top:16px;">å‰å¾€è®¾ç½®</button></div>' :
                    '<div style="text-align:center;padding:20px;color:var(--text-secondary);"><p>âœ… APIå·²é…ç½®ï¼Œè¯·è¾“å…¥ä½ çš„å›ç­”å¼€å§‹å¯¹è¯</p></div>') + '</div>';
            document.getElementById('aiModal').classList.add('show');
            document.getElementById('aiInput').focus();
        }

        function closeAIModal() { document.getElementById('aiModal').classList.remove('show'); }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message || !settings.apiKey) return;
            chatMessages.push({ role: 'user', content: message });
            input.value = '';
            const chatArea = document.getElementById('chatMessages');
            chatArea.innerHTML = chatMessages.map(m => '<div class="chat-message ' + (m.role === 'user' ? 'user' : 'ai') + '">' + (m.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–') + ' ' + m.content + '</div>').join('') + '<div class="chat-message ai">ğŸ¤– æ€è€ƒä¸­...</div>';
            const quarter = currentEpisode <= 13 ? 'q1' : currentEpisode <= 26 ? 'q2' : currentEpisode <= 39 ? 'q3' : 'q4';
            const ep = episodes[quarter].find(e => e.id === currentEpisode);
            const systemPrompt = 'ä½ æ˜¯æŠ•èµ„å­¦ä¹ åŠ©æ•™ã€‚å­¦ç”Ÿæ­£åœ¨å­¦ä¹ ç¬¬' + currentEpisode + 'æœŸã€Š' + ep.title + 'ã€‹ã€‚ç»ƒä¹ ç±»å‹ï¼š' + currentPromptData.title + 'ã€‚è¯¾ç¨‹å†…å®¹ï¼š' + episodeContext.substring(0, 1500) + 'ã€‚è¯·æ ¹æ®å­¦ç”Ÿå›ç­”è¿›è¡Œäº’åŠ¨æ•™å­¦ï¼Œç®€æ´æœ‰é’ˆå¯¹æ€§ã€‚';
            try {
                const response = await callAI(systemPrompt, chatMessages);
                chatMessages.push({ role: 'assistant', content: response });
                chatArea.innerHTML = chatMessages.map(m => '<div class="chat-message ' + (m.role === 'user' ? 'user' : 'ai') + '">' + (m.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–') + ' ' + m.content + '</div>').join('');
                chatArea.scrollTop = chatArea.scrollHeight;
            } catch (err) {
                chatArea.innerHTML = chatMessages.slice(0, -1).map(m => '<div class="chat-message ' + (m.role === 'user' ? 'user' : 'ai') + '">' + (m.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–') + ' ' + m.content + '</div>').join('') + '<div class="chat-message ai" style="color:#ef4444;">âŒ APIå¤±è´¥: ' + err.message + '</div>';
                chatMessages.pop();
            }
        }

        async function callAI(systemPrompt, messages) {
            const provider = settings.provider || 'openai';
            if (provider === 'openai') {
                const res = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey }, body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'system', content: systemPrompt }].concat(messages) }) });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.choices[0].message.content;
            } else if (provider === 'gemini') {
                const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + settings.apiKey, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + '\n\n' + messages.map(m => m.role + ': ' + m.content).join('\n') }] }] }) });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error('æš‚ä¸æ”¯æŒè¯¥AIæä¾›å•†');
        }

        function toggleComplete() {
            const btn = document.getElementById('completeBtn');
            if (completedEpisodes.includes(currentEpisode)) {
                completedEpisodes = completedEpisodes.filter(id => id !== currentEpisode);
                btn.textContent = 'âœ“ æ ‡è®°å®Œæˆ';
                btn.style.background = 'var(--success)';
            } else {
                completedEpisodes.push(currentEpisode);
                btn.textContent = 'âœ— å–æ¶ˆå®Œæˆ';
                btn.style.background = 'var(--bg-hover)';
            }
            saveUserProgress(); updateProgress(); renderEpisodeList();
        }

        function updateCompleteButton() {
            const btn = document.getElementById('completeBtn');
            if (completedEpisodes.includes(currentEpisode)) {
                btn.textContent = 'âœ— å–æ¶ˆå®Œæˆ';
                btn.style.background = 'var(--bg-hover)';
            } else {
                btn.textContent = 'âœ“ æ ‡è®°å®Œæˆ';
                btn.style.background = 'var(--success)';
            }
        }

        // Markdown parser with table and code block support
        function marked(text) {
            // Handle code blocks first
            const codeBlocks = [];
            text = text.replace(/```([^\n\r]*)([\r\n]+)([\s\S]*?)```/gm, (match, lang, newline, code) => {
                const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
                codeBlocks.push({ lang: lang.trim(), code: code });
                return placeholder;
            });

            // Handle inline code
            text = text.replace(/`([^`]+)`/g, '<code style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">$1</code>');

            // Handle tables
            const lines = text.split('\n');
            let inTable = false;
            let tableHtml = '';
            let result = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('|') && line.endsWith('|')) {
                    if (!inTable) {
                        inTable = true;
                        tableHtml = '<table style="width: 100%; border-collapse: collapse; margin: 16px 0;">';
                    }
                    // Skip separator line
                    if (line.match(/^\|[\s\-:|]+\|$/)) continue;

                    const cells = line.split('|').filter(c => c.trim());
                    const isHeader = !result.some(r => r.includes('<th'));
                    const tag = tableHtml.includes('<tr>') ? 'td' : 'th';
                    tableHtml += '<tr>';
                    cells.forEach(cell => {
                        tableHtml += `<${tag} style="border: 1px solid var(--border); padding: 8px 12px; text-align: left;">${cell.trim()}</${tag}>`;
                    });
                    tableHtml += '</tr>';
                } else {
                    if (inTable) {
                        tableHtml += '</table>';
                        result.push(tableHtml);
                        tableHtml = '';
                        inTable = false;
                    }
                    result.push(line);
                }
            }
            if (inTable) {
                tableHtml += '</table>';
                result.push(tableHtml);
            }

            text = result.join('\n');

            // Handle other markdown
            text = text
                .replace(/^### (.*$)/gim, '<h3 style="margin-top: 24px; margin-bottom: 12px;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="margin-top: 28px; margin-bottom: 14px;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="margin-top: 32px; margin-bottom: 16px;">$1</h1>')
                .replace(/\*\*([^*]+)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/gim, '<em>$1</em>')
                .replace(/^> (.*$)/gim, '<blockquote style="border-left: 4px solid var(--primary); padding-left: 16px; color: var(--text-secondary); margin: 16px 0;">$1</blockquote>')
                .replace(/^- (.*$)/gim, '<li style="margin-left: 20px;">$1</li>')
                .replace(/^---$/gim, '<hr style="border: none; border-top: 1px solid var(--border); margin: 24px 0;">')
                .replace(/\n\n/gim, '</p><p style="margin-bottom: 12px; line-height: 1.7;">')
                .replace(/\n/gim, '<br>');

            codeBlocks.forEach((block, index) => {
                const placeholder = `__CODE_BLOCK_${index}__`;
                const html = `<pre style="background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto; white-space: pre; font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace; font-variant-ligatures: none; line-height: 1.4; margin: 16px 0;"><code>${escapeHtml(block.code)}</code></pre>`;
                text = text.split(placeholder).join(html);
            });
            return text;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function showDashboard() {
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('episodeView').style.display = 'none';
        }

        function markComplete() {
            if (!completedEpisodes.includes(currentEpisode)) {
                completedEpisodes.push(currentEpisode);
                saveUserProgress();
                updateProgress();
                renderEpisodeList();
            }
            nextEpisode();
        }

        function updateProgress() {
            const percent = (completedEpisodes.length / 52) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${completedEpisodes.length}/52 æœŸå®Œæˆ`;
        }

        function prevEpisode() {
            if (currentEpisode > 1) loadEpisode(currentEpisode - 1);
        }

        function nextEpisode() {
            if (currentEpisode < 52) loadEpisode(currentEpisode + 1);
        }

        function startNextEpisode() {
            const next = completedEpisodes.length > 0 ? Math.max(...completedEpisodes) + 1 : 1;
            if (next <= 52) loadEpisode(next);
        }

        function openSettings() {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('settingsPanel').classList.add('open');
        }

        function closeSettings() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('settingsPanel').classList.remove('open');
        }

        function saveSettings() {
            settings = {
                provider: document.getElementById('aiProvider').value,
                apiKey: document.getElementById('apiKey').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
            closeSettings();
        }

        function loadSettings() {
            if (settings.provider) document.getElementById('aiProvider').value = settings.provider;
            if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        }

        function exportData() {
            const data = {
                completedEpisodes,
                settings,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'å­¦ä¹ æ•°æ®å¤‡ä»½.json';
            a.click();
        }

        function resetProgress() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿ')) {
                completedEpisodes = [];
                localStorage.setItem('completedEpisodes', '[]');
                updateProgress();
                renderEpisodeList();
            }
        }

        function openAIChat() {
            if (!settings.apiKey) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key');
                openSettings();
                return;
            }
            // TODO: Open AI chat interface
            alert('AIå¯¹è¯åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // Initialize on load
        init();
    </script>
</body>

</html>